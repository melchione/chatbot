services:
  sveltekit:
    build:
      context: sveltekit
      dockerfile: Dockerfile
      target: ${ENV:-development}
    ports:
      - "${EXTERNAL_SVELTEKIT_PORT:-8080}:8080"
      - "${EXTERNAL_SVELTEKIT_DEBUGGER_PORT:-9229}:9229"
    volumes:
      - ./sveltekit/.svelte-kit:/app/.svelte-kit
      - ./sveltekit/build:/app/build
      - ./sveltekit/src:/app/src
      - ./sveltekit/static:/app/static
      - ./sveltekit/jsconfig.json:/app/jsconfig.json
      - ./sveltekit/svelte.config.js:/app/svelte.config.js
      - ./sveltekit/vite.config.js:/app/vite.config.js
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PUBLIC_FAST_API_URL: ${PUBLIC_FAST_API_URL:-http://fast-api:8000}
      PUBLIC_FAST_API_WS_URL: ${PUBLIC_FAST_API_WS_URL:-ws://fast-api:8000}
      JWT_SECRET: ${JWT_SECRET}
      FRONTEND_URL: ${FRONTEND_URL}
    networks:
      - chatbot_default
  fast-api:
    build:
      context: ./fast-api
      dockerfile: Dockerfile
      target: ${ENV:-${TARGET:-development}}
    ports:
      - "${EXTERNAL_FASTAPI_PORT:-8000}:8000"
      - "${EXTERNAL_FASTAPI_DEBUGGER_PORT:-4567}:4567"
    volumes:
      - ./fast-api/database:/app/database
      - ./fast-api:/app
      - ./fast-api/uv.lock:/app/uv.lock
      - ./fast-api/pyproject.toml:/app/pyproject.toml
      - ./gcp-service-account-key.json:/app/gcp-service-account-key.json:ro # Montez la clé en lecture seule
    environment:
      ENV: ${ENV:-development}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      STRICT_ENVIRONMENT: ${STRICT_ENVIRONMENT:-${ENVIRONMENT:-development}}
      TARGET_FASTAPI: ${TARGET_FASTAPI:-development}
      DOMAIN: ${DOMAIN}
      FRONT_DOMAIN: ${FRONT_DOMAIN}
      GOOGLE_APPLICATION_CREDENTIALS: /app/gcp-service-account-key.json # Chemin à l'intérieur du conteneur
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      GOOGLE_CLOUD_LOCATION: ${GOOGLE_CLOUD_LOCATION}
      AGENT_RESOURCE_ID: ${AGENT_RESOURCE_ID}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    networks:
      - chatbot_default


networks:
  chatbot_default:
    driver: bridge
