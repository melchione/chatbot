<!doctype html>
<html>

<head>
    <title>FastAPI Vertex AI Chat</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        #messages {
            height: 300px;
            width: 500px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        .message {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 5px;
        }

        .user-message {
            background-color: #e1f5fe;
            text-align: right;
        }

        .agent-message {
            background-color: #f1f8e9;
        }

        .error-message {
            background-color: #ffcdd2;
            color: #c62828;
        }

        #messageForm input {
            width: 400px;
            padding: 8px;
            margin-right: 5px;
        }

        #messageForm button {
            padding: 8px;
        }
    </style>
</head>

<body>
    <h1>FastAPI Vertex AI Chat</h1>
    <div id="messages"></div>
    <form id="messageForm">
        <input type="text" id="message" autocomplete="off" placeholder="Type your message..." />
        <button type="submit" id="sendButton">Send</button>
    </form>

    <script>
        const messagesDiv = document.getElementById("messages");
        const messageForm = document.getElementById("messageForm");
        const messageInput = document.getElementById("message");
        const sendButton = document.getElementById("sendButton");

        const userId = "test_user"; // User ID fixe pour le moment
        let sessionId = getCookie("chat_session_id");
        let ws;

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function setCookie(name, value, days = 7) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        async function loadChatHistory(currentUserId, currentSessionId) {
            addMessage("Loading chat history...", "system-message");
            try {
                const response = await fetch(`/session_history/${currentUserId}/${currentSessionId}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: "Failed to fetch history, server returned: " + response.status }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.events && data.events.length > 0) {
                    messagesDiv.innerHTML = ''; // Clear previous messages like "Loading..."
                    data.events.forEach(event => {
                        // Assuming the event structure provided in the prompt
                        if (event.content && event.content.parts && event.content.parts.length > 0) {
                            const part = event.content.parts[0];
                            if (part.text) {
                                const messageType = event.author === 'user' ? "user-message" : "agent-message";
                                // Pour l'historique, on ne simule pas le streaming, on affiche le message complet.
                                let existingMessage = messagesDiv.querySelector(`[data-event-id="${event.id}"]`);
                                if (!existingMessage) { // Eviter les doublons si la fonction est appelée plusieurs fois
                                    const messageElement = document.createElement("div");
                                    messageElement.classList.add("message", messageType);
                                    messageElement.innerHTML = part.text.replace(/\n/g, "<br>");
                                    messageElement.dataset.eventId = event.id; // Marqueur pour éviter doublons
                                    messagesDiv.appendChild(messageElement);
                                }
                            }
                        }
                    });
                    addMessage("Chat history loaded.", "system-message");
                } else {
                    addMessage("No previous chat history found or session is new.", "system-message");
                }
            } catch (error) {
                console.error("Error loading chat history:", error);
                addMessage("Error loading chat history: " + error.message, "error-message");
                // On continue quand même vers la connexion WebSocket
            }
            scrollToBottom();
        }

        async function initializeSessionAndConnect() {
            sendButton.disabled = true;
            addMessage("Initializing session...", "system-message");

            if (!sessionId) {
                console.log("No session ID in cookies, creating a new one...");
                try {
                    // L'ID client pour la création de session peut être simple, il sert juste à initier.
                    const sessionCreationClientId = "session-creator-" + Math.random().toString(36).substring(2, 15);
                    const createSessionWsUrl = ((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/ws/create_session/" + sessionCreationClientId;

                    const sessionWs = new WebSocket(createSessionWsUrl);

                    sessionWs.onopen = () => {
                        console.log("Connected to create_session endpoint.");
                    };

                    sessionWs.onmessage = async (event) => { // rendue async
                        const data = JSON.parse(event.data);
                        if (data.type === "session_created" && data.session_id) {
                            sessionId = data.session_id;
                            setCookie("chat_session_id", sessionId);
                            console.log("New session ID received and stored:", sessionId);
                            addMessage("Session created: " + sessionId, "system-message");
                            sessionWs.close();
                            // Pas besoin de charger l'historique ici, car c'est une nouvelle session
                            connectToChat();
                        } else {
                            console.error("Failed to create session:", data);
                            addMessage("Error: Could not create session. " + (data.message || ""), "error-message");
                        }
                    };
                    sessionWs.onerror = (error) => {
                        console.error("WebSocket error during session creation:", error);
                        addMessage("Error: Could not connect to create session. Check console.", "error-message");
                        sendButton.disabled = false;
                    };

                    sessionWs.onclose = () => {
                        console.log("Session creation WebSocket closed.");
                    };

                } catch (error) {
                    console.error("Failed to connect to session creation endpoint:", error);
                    addMessage("Fatal error: Could not initiate session creation. Check console.", "error-message");
                }
            } else {
                console.log("Using existing session ID from cookies:", sessionId);
                addMessage("Using existing session: " + sessionId, "system-message");
                await loadChatHistory(userId, sessionId); // Charger l'historique AVANT de connecter au chat
                connectToChat();
            }
        }

        function connectToChat() {
            if (!sessionId) {
                addMessage("Error: No session ID available to connect to chat.", "error-message");
                sendButton.disabled = true;
                return;
            }
            const chatWsUrl = ((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/ws/" + userId + "/" + sessionId;
            ws = new WebSocket(chatWsUrl);

            ws.onopen = () => {
                console.log("Connected to WebSocket server with User ID:", userId, "and Session ID:", sessionId);
                sendButton.disabled = false;
                addMessage("Connected to agent.", "system-message");
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("Received:", data);
                if (data.type === "message_part" && data.text) {
                    // Append to the last agent message if it exists, otherwise create new
                    let lastMessage = messagesDiv.lastElementChild;
                    if (lastMessage && lastMessage.classList.contains("agent-message") && !lastMessage.dataset.completed) {
                        lastMessage.innerHTML += data.text.replace(/\n/g, "<br>");
                    } else {
                        addMessage(data.text.replace(/\n/g, "<br>"), "agent-message");
                    }
                } else if (data.type === "message_end") {
                    let lastMessage = messagesDiv.lastElementChild;
                    if (lastMessage && lastMessage.classList.contains("agent-message")) {
                        lastMessage.dataset.completed = "true"; // Mark as completed
                    }
                    scrollToBottom();
                } else if (data.type === "error" && data.message) {
                    addMessage("Error: " + data.message, "error-message");
                } else if (data.text) { // Fallback for simple text messages
                    addMessage(data.text, "agent-message");
                }
            };

            ws.onclose = () => {
                console.log("Disconnected from WebSocket server.");
                sendButton.disabled = true;
                addMessage("Disconnected. Attempting to reconnect in 5 seconds...", "system-message");
                setTimeout(initializeSessionAndConnect, 5000); // Try to reconnect by re-initializing session
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
                addMessage("WebSocket error. Check console.", "error-message");
                ws.close(); // This will trigger onclose and attempt reconnection
            };
        }

        function addMessage(text, type) {
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", type);
            messageElement.innerHTML = text; // Use innerHTML to render <br>
            messagesDiv.appendChild(messageElement);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        messageForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const messageText = messageInput.value;
            if (messageText && ws && ws.readyState === WebSocket.OPEN) {
                const payload = {
                    type: "text", // Ou "image" si vous implémentez l'envoi d'images
                    data: messageText
                };
                ws.send(JSON.stringify(payload));
                addMessage(messageText, "user-message");
                messageInput.value = "";
            }
        });

        initializeSessionAndConnect(); // Start the process
    </script>
</body>

</html>